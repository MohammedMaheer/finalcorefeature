<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interviewer Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .container-fluid {
      padding: 0;
    }
    .sidebar {
      background-color: #212529;
      color: white;
      min-height: 100vh;
      padding: 20px 15px;
    }
    .sidebar-title {
      font-size: 20px;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
    }
    .sidebar-title i {
      margin-right: 10px;
      font-size: 24px;
    }
    .room-info {
      background-color: #343a40;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
    }
    .room-id {
      font-family: monospace;
      padding: 8px;
      background-color: #495057;
      border-radius: 4px;
      margin-top: 8px;
      font-size: 14px;
      text-align: center;
    }
    .copy-button {
      background-color: #6c757d;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      margin-top: 8px;
      width: 100%;
      font-size: 14px;
    }
    .copy-button:hover {
      background-color: #5c636a;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      margin-top: 15px;
      font-size: 14px;
    }
    .status-circle {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-waiting {
      background-color: #ffc107;
    }
    .status-connected {
      background-color: #28a745;
    }
    .status-disconnected {
      background-color: #dc3545;
    }
    .main-content {
      padding: 20px;
    }
    .header {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .video-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .video-box {
      flex: 1;
      position: relative;
      background-color: #212529;
      border-radius: 8px;
      overflow: hidden;
    }
    .video-label {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: rgba(0,0,0,0.5);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    video {
      width: 100%;
      height: 320px;
      object-fit: cover;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .control-btn {
      border-radius: 50%;
      width: 50px;
      height: 50px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }
    .mute-btn {
      background-color: #6c757d;
    }
    .mute-btn.active {
      background-color: #dc3545;
    }
    .video-btn {
      background-color: #6c757d;
    }
    .video-btn.active {
      background-color: #dc3545;
    }
    .end-btn {
      background-color: #dc3545;
    }
    .tab-content {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .nav-tabs {
      border-bottom: none;
      margin-bottom: 20px;
    }
    .nav-tabs .nav-link {
      border: none;
      color: #6c757d;
      font-weight: 500;
    }
    .nav-tabs .nav-link.active {
      color: #0d6efd;
      border-bottom: 2px solid #0d6efd;
      background-color: transparent;
    }
    .transcript-container {
      height: 300px;
      overflow-y: auto;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .transcript-msg {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e9ecef;
    }
    .transcript-user {
      font-weight: 600;
      margin-bottom: 5px;
    }
    .interviewer-msg .transcript-user {
      color: #0d6efd;
    }
    .candidate-msg .transcript-user {
      color: #6c757d;
    }
    .transcript-text {
      color: #212529;
    }
    .notes-container textarea {
      width: 100%;
      height: 300px;
      padding: 15px;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      resize: none;
    }
    .report-container {
      background-color: #f8f9fa;
      border-radius: 6px;
      padding: 15px;
      border: 1px solid #e9ecef;
    }
    .generate-report-btn {
      margin-top: 15px;
    }
    .malpractice-alert {
      background-color: #f8d7da;
      color: #842029;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    .malpractice-alert i {
      font-size: 24px;
      margin-right: 10px;
    }
    .performance-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }
    .metric-card {
      background-color: white;
      border-radius: 6px;
      padding: 15px;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .metric-title {
      color: #6c757d;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .metric-value {
      font-size: 20px;
      font-weight: 600;
    }
    .metric-good {
      color: #198754;
    }
    .metric-average {
      color: #fd7e14;
    }
    .metric-poor {
      color: #dc3545;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 sidebar">
        <div class="sidebar-title">
          <i class="bi bi-camera-video-fill"></i>
          <span>Interview Dashboard</span>
        </div>
        
        <div class="room-info">
          <h6>Interview Room ID</h6>
          <div id="roomId" class="room-id">Loading...</div>
          <button id="copyRoomId" class="copy-button">
            <i class="bi bi-clipboard"></i> Copy to clipboard
          </button>
          <div class="status-indicator">
            <div class="status-circle status-waiting" id="statusCircle"></div>
            <span id="connectionStatus">Waiting for candidate...</span>
          </div>
        </div>
        
        <h6>Malpractice Detection</h6>
        <div id="malpracticeList" class="mt-2 mb-4">
          <div class="text-muted small">No issues detected</div>
        </div>
        
        <h6>Interview Timer</h6>
        <div id="interviewTimer" class="fs-4 fw-bold mt-2 mb-4">00:00:00</div>
        
        <button id="startGenerateReport" class="btn btn-primary w-100 mt-3">
          <i class="bi bi-file-earmark-text"></i> Generate Report
        </button>
      </div>
      
      <!-- Main Content -->
      <div class="col-md-9 col-lg-10 main-content">
        <div class="header">
          <h4>Interview Session</h4>
          <div>
            <span class="badge bg-success me-2" id="transcriptionStatus">Transcription Active</span>
            <span class="badge bg-success" id="detectionStatus">Malpractice Detection Active</span>
          </div>
        </div>
        
        <!-- Malpractice Alert -->
        <div class="malpractice-alert hidden" id="malpracticeAlert">
          <i class="bi bi-exclamation-triangle-fill"></i>
          <div>
            <strong>Malpractice Detected!</strong>
            <span id="malpracticeMessage">Candidate switched to another tab</span>
          </div>
        </div>
        
        <!-- Video Container -->
        <div class="video-container">
          <div class="video-box">
            <video id="localVideo" autoplay muted></video>
            <div class="video-label">You (Interviewer)</div>
          </div>
          <div class="video-box">
            <video id="remoteVideo" autoplay></video>
            <div class="video-label">Candidate</div>
          </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
          <button id="muteBtn" class="control-btn mute-btn">
            <i class="bi bi-mic-fill"></i>
          </button>
          <button id="videoToggleBtn" class="control-btn video-btn">
            <i class="bi bi-camera-video-fill"></i>
          </button>
          <button id="endCallBtn" class="control-btn end-btn">
            <i class="bi bi-telephone-x-fill"></i>
          </button>
        </div>
        
        <!-- Tabs -->
        <ul class="nav nav-tabs" id="interviewTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="transcript-tab" data-bs-toggle="tab" data-bs-target="#transcript" type="button" role="tab">
              Transcript
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
              Notes
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab">
              AI Report
            </button>
          </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="interviewTabsContent">
          <!-- Transcript Tab -->
          <div class="tab-pane fade show active" id="transcript" role="tabpanel">
            <div class="d-flex justify-content-between mb-3">
              <h5>Live Transcript</h5>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoTranscriptSwitch" checked>
                <label class="form-check-label" for="autoTranscriptSwitch">Auto-transcribe</label>
              </div>
            </div>
            <div class="transcript-container" id="transcriptContainer">
              <div class="text-center text-muted py-5">
                Transcript will appear here once the interview begins
              </div>
            </div>
          </div>
          
          <!-- Notes Tab -->
          <div class="tab-pane fade" id="notes" role="tabpanel">
            <h5 class="mb-3">Interview Notes</h5>
            <textarea id="interviewNotes" placeholder="Type your interview notes here..."></textarea>
          </div>
          
          <!-- AI Report Tab -->
          <div class="tab-pane fade" id="report" role="tabpanel">
            <div class="d-flex justify-content-between mb-3">
              <h5>AI Performance Report</h5>
              <button class="btn btn-sm btn-outline-primary" id="regenerateReportBtn">
                <i class="bi bi-arrow-clockwise"></i> Regenerate
              </button>
            </div>
            
            <div id="reportLoading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status"></div>
              <div class="mt-3">Generating AI report based on interview data...</div>
            </div>
            
            <div id="reportContent" class="report-container hidden">
              <h4 id="candidateName">Candidate Performance Report</h4>
              
              <div class="performance-metrics">
                <div class="metric-card">
                  <div class="metric-title">Technical Skills</div>
                  <div class="metric-value metric-good" id="technicalScore">9/10</div>
                </div>
                <div class="metric-card">
                  <div class="metric-title">Communication</div>
                  <div class="metric-value metric-average" id="communicationScore">7/10</div>
                </div>
                <div class="metric-card">
                  <div class="metric-title">Problem Solving</div>
                  <div class="metric-value metric-good" id="problemSolvingScore">8/10</div>
                </div>
                <div class="metric-card">
                  <div class="metric-title">Integrity Score</div>
                  <div class="metric-value metric-average" id="integrityScore">7/10</div>
                </div>
              </div>
              
              <div class="mt-4">
                <h6>Summary</h6>
                <p id="reportSummary">The AI-generated summary will appear here after the report is generated.</p>
              </div>
              
              <div class="mt-3">
                <h6>Strengths</h6>
                <ul id="strengthsList">
                  <li>Placeholder strength</li>
                </ul>
              </div>
              
              <div class="mt-3">
                <h6>Areas for Improvement</h6>
                <ul id="improvementsList">
                  <li>Placeholder improvement area</li>
                </ul>
              </div>
              
              <div class="mt-3">
                <h6>Malpractice Incidents</h6>
                <div id="malpracticeReport">No malpractice incidents detected during the interview.</div>
              </div>
              
              <div class="mt-4">
                <button class="btn btn-sm btn-outline-secondary" id="downloadReportBtn">
                  <i class="bi bi-download"></i> Download Report
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Generate a room ID
    const roomId = Math.random().toString(36).substring(2, 10).toUpperCase();
    const userId = Math.random().toString(36).substring(2, 15);
    document.getElementById('roomId').textContent = roomId;
    
    // Socket.io connection
    const socket = io();
    let localStream;
    let remoteStream;
    let peerConnection;
    let isInterviewer = true;
    let transcriptData = [];
    let malpracticeIncidents = [];
    let recognition;
    let interviewTimerInterval;
    let interviewStartTime;
    let audioContext;
    let isTranscribing = true;
    let isMuted = false;
    let isVideoOff = false;

    // STUN servers for NAT traversal
    const iceServers = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    };

    // DOM elements
    const copyRoomIdBtn = document.getElementById('copyRoomId');
    const muteBtn = document.getElementById('muteBtn');
    const videoToggleBtn = document.getElementById('videoToggleBtn');
    const endCallBtn = document.getElementById('endCallBtn');
    const transcriptContainer = document.getElementById('transcriptContainer');
    const autoTranscriptSwitch = document.getElementById('autoTranscriptSwitch');
    const interviewNotes = document.getElementById('interviewNotes');
    const generateReportBtn = document.getElementById('startGenerateReport');
    const regenerateReportBtn = document.getElementById('regenerateReportBtn');
    const downloadReportBtn = document.getElementById('downloadReportBtn');
    const malpracticeAlert = document.getElementById('malpracticeAlert');
    const malpracticeMessage = document.getElementById('malpracticeMessage');
    const malpracticeList = document.getElementById('malpracticeList');
    const statusCircle = document.getElementById('statusCircle');
    const connectionStatus = document.getElementById('connectionStatus');
    const interviewTimer = document.getElementById('interviewTimer');
    
    // Copy room ID to clipboard
    copyRoomIdBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(roomId);
      copyRoomIdBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyRoomIdBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy to clipboard';
      }, 2000);
    });

    // Set up media and join room
    async function init() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        
        // Initialize speech recognition if available
        if ('webkitSpeechRecognition' in window) {
          setupSpeechRecognition();
        } else {
          autoTranscriptSwitch.disabled = true;
          autoTranscriptSwitch.checked = false;
          document.getElementById('transcriptionStatus').classList.replace('bg-success', 'bg-danger');
          document.getElementById('transcriptionStatus').textContent = 'Transcription Unavailable';
        }
        
        joinRoom();
        
        // Set up UI controls
        muteBtn.addEventListener('click', toggleMute);
        videoToggleBtn.addEventListener('click', toggleVideo);
        endCallBtn.addEventListener('click', endCall);
        autoTranscriptSwitch.addEventListener('change', toggleTranscription);
        generateReportBtn.addEventListener('click', generateReport);
        regenerateReportBtn.addEventListener('click', generateReport);
        downloadReportBtn.addEventListener('click', downloadReport);
        
        // Start timer when interview begins
        startInterviewTimer();
        
        // Setup visibility change detection
        document.addEventListener('visibilitychange', handleVisibilityChange);
      } catch (error) {
        console.error('Error accessing media devices:', error);
        alert('Failed to access camera and microphone. Please ensure they are connected and permissions are granted.');
      }
    }

    function joinRoom() {
      socket.emit('join-room', roomId, userId, 'interviewer');
      
      socket.on('user-connected', (otherUserId, userType) => {
        if (userType === 'candidate') {
          statusCircle.classList.remove('status-waiting');
          statusCircle.classList.add('status-connected');
          connectionStatus.textContent = 'Candidate connected!';
          
          createPeerConnection(otherUserId);
          
          // As the interviewer, we initiate the offer
          createOffer();
          
          // Add connected timestamp to transcript
          addSystemMessage('Candidate joined the interview');
        }
      });
      
      socket.on('offer', async (offer, senderId) => {
        if (!peerConnection) {
          createPeerConnection(senderId);
        }
        try {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          socket.emit('answer', roomId, answer);
        } catch (error) {
          console.error('Error handling offer:', error);
        }
      });
      
      socket.on('answer', async (answer) => {
        try {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        } catch (error) {
          console.error('Error handling answer:', error);
        }
      });
      
      socket.on('ice-candidate', async (candidate) => {
        try {
          if (peerConnection) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
          }
        } catch (error) {
          console.error('Error adding ice candidate:', error);
        }
      });
      
      socket.on('user-disconnected', () => {
        statusCircle.classList.remove('status-connected');
        statusCircle.classList.add('status-disconnected');
        connectionStatus.textContent = 'Candidate disconnected.';
        document.getElementById('remoteVideo').srcObject = null;
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }
        addSystemMessage('Candidate left the interview');
      });
      
      socket.on('tab-switch-detected', () => {
        displayMalpractice('Tab Switch', 'Candidate switched to another tab or window');
      });
      
      socket.on('transcription', (transcript, fromUserId) => {
        if (fromUserId !== userId) {
          addTranscriptMessage('Candidate', transcript);
        }
      });
    }

    function createPeerConnection(otherUserId) {
      peerConnection = new RTCPeerConnection(iceServers);
      
      // Add local tracks to the connection
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });
      
      // Handle incoming remote stream
      peerConnection.ontrack = event => {
        document.getElementById('remoteVideo').srcObject = event.streams[0];
        remoteStream = event.streams[0];
        
        // Setup malpractice detection for video
        if (event.track.kind === 'video') {
          setupObjectDetection(event.streams[0]);
        }
      };
      
      // Handle ICE candidates
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          socket.emit('ice-candidate', roomId, event.candidate);
        }
      };
      
      peerConnection.onconnectionstatechange = event => {
        if (peerConnection.connectionState === 'connected') {
          statusCircle.classList.remove('status-waiting');
          statusCircle.classList.add('status-connected');
          connectionStatus.textContent = 'Connected to candidate.';
        }
      };
    }

    async function createOffer() {
      try {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('offer', roomId, offer);
      } catch (error) {
        console.error('Error creating offer:', error);
      }
    }

    function setupSpeechRecognition() {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      
      let currentTranscript = '';
      
      recognition.onresult = (event) => {
        if (!isTranscribing) return;
        
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        
        if (finalTranscript && finalTranscript !== currentTranscript) {
          currentTranscript = finalTranscript;
          addTranscriptMessage('Interviewer', finalTranscript);
          socket.emit('transcription', roomId, finalTranscript, userId);
        }
      };
      
      recognition.onerror = (event) => {
        console.error('Speech recognition error', event.error);
        if (event.error === 'no-speech') {
          // Restart recognition if it stops due to no speech
          recognition.stop();
          setTimeout(() => {
            if (isTranscribing) recognition.start();
          }, 1000);
        }
      };
      
      recognition.onend = () => {
        // Restart recognition if it ends and should be active
        if (isTranscribing) {
          try {
            recognition.start();
          } catch (e) {
            console.error('Error restarting speech recognition:', e);
          }
        }
      };
      
      // Start recognition
      try {
        recognition.start();
      } catch (e) {
        console.error('Error starting speech recognition:', e);
      }
    }

    function toggleTranscription() {
      isTranscribing = autoTranscriptSwitch.checked;
      
      if (isTranscribing && recognition) {
        try {
          recognition.start();
          document.getElementById('transcriptionStatus').classList.replace('bg-danger', 'bg-success');
          document.getElementById('transcriptionStatus').textContent = 'Transcription Active';
        } catch (e) {
          console.error('Error starting speech recognition:', e);
        }
      } else if (recognition) {
        recognition.stop();
        document.getElementById('transcriptionStatus').classList.replace('bg-success', 'bg-danger');
        document.getElementById('transcriptionStatus').textContent = 'Transcription Paused';
      }
    }

    function addTranscriptMessage(user, text) {
      const timestamp = new Date().toLocaleTimeString();
      const messageData = { user, text, timestamp };
      transcriptData.push(messageData);
      
      const messageDiv = document.createElement('div');
      messageDiv.className = user === 'Interviewer' ? 'transcript-msg interviewer-msg' : 'transcript-msg candidate-msg';
      
      messageDiv.innerHTML = `
        <div class="transcript-user">${user} <small class="text-muted">${timestamp}</small></div>
        <div class="transcript-text">${text}</div>
      `;
      
      transcriptContainer.appendChild(messageDiv);
      transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
    }

    function addSystemMessage(text) {
      const timestamp = new Date().toLocaleTimeString();
      const messageDiv = document.createElement('div');
      messageDiv.className = 'transcript-msg text-center';
      
      messageDiv.innerHTML = `
        <div class="transcript-text text-muted">
          <i class="bi bi-info-circle"></i> ${text} <small>${timestamp}</small>
        </div>
      `;
      
      transcriptContainer.appendChild(messageDiv);
      transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
    }

    function toggleMute() {
      const audioTracks = localStream.getAudioTracks();
      if (audioTracks.length === 0) return;
      
      isMuted = !isMuted;
      audioTracks[0].enabled = !isMuted;
      
      muteBtn.innerHTML = isMuted ? 
        '<i class="bi bi-mic-mute-fill"></i>' : 
        '<i class="bi bi-mic-fill"></i>';
      
      muteBtn.classList.toggle('active', isMuted);
    }

    function toggleVideo() {
      const videoTracks = localStream.getVideoTracks();
      if (videoTracks.length === 0) return;
      
      isVideoOff = !isVideoOff;
      videoTracks[0].enabled = !isVideoOff;
      
      videoToggleBtn.innerHTML = isVideoOff ? 
        '<i class="bi bi-camera-video-off-fill"></i>' : 
        '<i class="bi bi-camera-video-fill"></i>';
      
      videoToggleBtn.classList.toggle('active', isVideoOff);
    }

    function endCall() {
      if (confirm('Are you sure you want to end this interview?')) {
        stopInterviewTimer();
        if (recognition) recognition.stop();
        window.location.href = '/';
      }
    }

    function startInterviewTimer() {
      interviewStartTime = new Date();
      interviewTimerInterval = setInterval(updateTimer, 1000);
    }

    function stopInterviewTimer() {
      clearInterval(interviewTimerInterval);
    }

    function updateTimer() {
      const now = new Date();
      const diff = now - interviewStartTime;
      const hours = Math.floor(diff / 3600000);
      const minutes = Math.floor((diff % 3600000) / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);
      
      interviewTimer.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function handleVisibilityChange() {
      if (document.hidden) {
        // Interviewer tab is hidden
      } else {
        // Interviewer tab is visible again
      }
    }

    function displayMalpractice(type, message) {
      const timestamp = new Date().toLocaleTimeString();
      malpracticeIncidents.push({ type, message, timestamp });
      
      // Add to malpractice list in sidebar
      const malpracticeItem = document.createElement('div');
      malpracticeItem.className = 'text-danger small mb-2';
      malpracticeItem.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${type} (${timestamp})`;
      
      // Clear "No issues detected" message if it exists
      if (malpracticeList.querySelector('.text-muted')) {
        malpracticeList.innerHTML = '';
      }
      
      malpracticeList.appendChild(malpracticeItem);
      
      // Show alert
      malpracticeMessage.textContent = message;
      malpracticeAlert.classList.remove('hidden');
      
      // Hide alert after 5 seconds
      setTimeout(() => {
        malpracticeAlert.classList.add('hidden');
      }, 5000);
    }

    // Simulate object detection in video feed
    function setupObjectDetection(stream) {
      // For this demo, we'll just simulate object detection
      // In a real implementation, this would use a computer vision API or model
      const detectObjects = () => {
        // Simulate random object detection occasionally
        if (Math.random() < 0.05) {
          const objects = ['phone', 'person', 'book', 'notes'];
          const detectedObject = objects[Math.floor(Math.random() * objects.length)];
          displayMalpractice('Object Detected', `Detected ${detectedObject} in candidate's view`);
        }
      };
      
      // Check every 10 seconds (would be more frequent in real implementation)
      const objectDetectionInterval = setInterval(detectObjects, 10000);
      
      // Clean up when stream ends
      stream.getVideoTracks()[0].onended = () => {
        clearInterval(objectDetectionInterval);
      };
    }

    // Generate AI report
    function generateReport() {
      // Show loading state
      document.getElementById('reportLoading').classList.remove('hidden');
      document.getElementById('reportContent').classList.add('hidden');
      
      // Simulate AI processing time
      setTimeout(() => {
        generateAIReport();
        
        // Hide loading state and show report
        document.getElementById('reportLoading').classList.add('hidden');
        document.getElementById('reportContent').classList.remove('hidden');
      }, 2000);
    }

    function generateAIReport() {
      // In a real implementation, this would call an API to generate the report
      // based on the transcript and malpractice data
      
      // For demo purposes, we'll generate a simulated report
      const technicalScore = 7 + Math.floor(Math.random() * 4);
      const communicationScore = 6 + Math.floor(Math.random() * 5);
      const problemSolvingScore = 6 + Math.floor(Math.random() * 5);
      
      // Calculate integrity score based on malpractice incidents
      const integrityScore = Math.max(3, 10 - malpracticeIncidents.length * 2);
      
      // Update the report UI
      document.getElementById('technicalScore').textContent = `${technicalScore}/10`;
      document.getElementById('communicationScore').textContent = `${communicationScore}/10`;
      document.getElementById('problemSolvingScore').textContent = `${problemSolvingScore}/10`;
      document.getElementById('integrityScore').textContent = `${integrityScore}/10`;
      
      // Set color classes based on scores
      setScoreClass('technicalScore', technicalScore);
      setScoreClass('communicationScore', communicationScore);
      setScoreClass('problemSolvingScore', problemSolvingScore);
      setScoreClass('integrityScore', integrityScore);
      
      // Generate summary
      const overallScore = Math.round((technicalScore + communicationScore + problemSolvingScore + integrityScore) / 4);
      let summary = '';
      
      if (overallScore >= 8) {
        summary = 'The candidate demonstrated strong technical knowledge and excellent communication skills throughout the interview. Their problem-solving approach was methodical and effective.';
      } else if (overallScore >= 6) {
        summary = 'The candidate showed adequate technical knowledge with good communication skills. Their problem-solving approach was satisfactory but could be improved in some areas.';
      } else {
        summary = 'The candidate struggled with technical questions and their communication could be improved. Their problem-solving approach lacked structure and effectiveness.';
      }
      
      if (malpracticeIncidents.length > 0) {
        summary += ` However, there were ${malpracticeIncidents.length} integrity concerns during the interview that should be considered in the evaluation.`;
      }
      
      document.getElementById('reportSummary').textContent = summary;
      
      // Generate strengths
      const strengthsList = document.getElementById('strengthsList');
      strengthsList.innerHTML = '';
      
      const possibleStrengths = [
        'Strong technical knowledge in relevant areas',
        'Clear and concise communication',
        'Excellent problem-solving approach',
        'Good understanding of industry best practices',
        'Demonstrated ability to work under pressure',
        'Asked insightful questions about the role'
      ];
      
      // Select 2-4 strengths
      const numStrengths = 2 + Math.floor(Math.random() * 3);
      const selectedStrengths = shuffleArray(possibleStrengths).slice(0, numStrengths);
      
      selectedStrengths.forEach(strength => {
        const li = document.createElement('li');
        li.textContent = strength;
        strengthsList.appendChild(li);
      });
      
      // Generate improvement areas
      const improvementsList = document.getElementById('improvementsList');
      improvementsList.innerHTML = '';
      
      const possibleImprovements = [
        'Could improve depth of technical knowledge in some areas',
        'Communication could be more structured',
        'Problem-solving approach could be more methodical',
        'Could provide more specific examples from past experience',
        'Would benefit from more practical experience with mentioned technologies',
        'Should work on concise explanations of complex concepts'
      ];
      
      // Select 2-3 improvement areas
      const numImprovements = 2 + Math.floor(Math.random() * 2);
      const selectedImprovements = shuffleArray(possibleImprovements).slice(0, numImprovements);
      
      selectedImprovements.forEach(improvement => {
        const li = document.createElement('li');
        li.textContent = improvement;
        improvementsList.appendChild(li);
      });
      
      // Display malpractice incidents
      const malpracticeReport = document.getElementById('malpracticeReport');
      
      if (malpracticeIncidents.length > 0) {
        let malpracticeHTML = '<ul class="mt-2 text-danger">';
        
        malpracticeIncidents.forEach(incident => {
          malpracticeHTML += `<li>${incident.type}: ${incident.message} (${incident.timestamp})</li>`;
        });
        
        malpracticeHTML += '</ul>';
        malpracticeReport.innerHTML = `${malpracticeIncidents.length} malpractice incidents detected:${malpracticeHTML}`;
      } else {
        malpracticeReport.textContent = 'No malpractice incidents detected during the interview.';
      }
    }

    function setScoreClass(elementId, score) {
      const element = document.getElementById(elementId);
      element.classList.remove('metric-good', 'metric-average', 'metric-poor');
      
      if (score >= 8) {
        element.classList.add('metric-good');
      } else if (score >= 6) {
        element.classList.add('metric-average');
      } else {
        element.classList.add('metric-poor');
      }
    }

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function downloadReport() {
      const reportContent = document.getElementById('reportContent').innerText;
      const blob = new Blob([reportContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `candidate_report_${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initialize when document is ready
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>